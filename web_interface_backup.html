<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Analyzer - An√°lise de T√©cnica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .content {
            padding: 40px;
        }
        .section {
            margin-bottom: 40px;
        }
        .section h2 {
            color: #2c5530;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .login-section {
            max-width: 400px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus {
            border-color: #4a7c59;
            outline: none;
        }
        .btn {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .upload-area {
            border: 3px dashed #4a7c59;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-area:hover {
            background: #e9ecef;
            border-color: #2c5530;
        }
        .upload-area.dragover {
            background: #e8f5e8;
            border-color: #2c5530;
        }
        .file-info {
            background: #e8f5e8;
            border: 2px solid #4a7c59;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .professional-card {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .professional-card:hover {
            border-color: #4a7c59;
            background: #e8f5e8;
        }
        .professional-card.selected {
            border-color: #2c5530;
            background: #2c5530;
            color: white;
        }
        .professionals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .results {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
        }
        .score {
            font-size: 4em;
            font-weight: bold;
            color: #e17055;
            margin: 20px 0;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a7c59;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéæ Tennis Analyzer</h1>
            <p>An√°lise Avan√ßada de T√©cnica de T√™nis de Mesa</p>
        </div>

        <div class="content">
            <!-- Login Section -->
            <div id="loginSection" class="section">
                <div class="login-section">
                    <h2>üîí Login</h2>
                    <div class="form-group">
                        <label for="username">Usu√°rio:</label>
                        <input type="text" id="username" value="demo">
                    </div>
                    <div class="form-group">
                        <label for="password">Senha:</label>
                        <input type="password" id="password" value="demo123">
                    </div>
                    <button class="btn" onclick="login()">ENTRAR</button>
                </div>
            </div>

            <!-- Analysis Section -->
            <div id="analysisSection" class="section">
                <h2>üé• An√°lise de V√≠deo</h2>
                
                <div class="form-group">
                    <label>Selecionar V√≠deo:</label>
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div id="uploadText">
                            <p><strong>Clique aqui ou arraste um v√≠deo</strong></p>
                            <p>Formatos suportados: MP4, AVI, MOV</p>
                        </div>
                        <div id="fileInfo" class="file-info hidden">
                            <span id="fileName"></span>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".mp4,.avi,.mov" style="display: none;" onchange="handleFileSelect(this.files[0])">
                </div>

                <h2>‚öôÔ∏è Configura√ß√µes da An√°lise</h2>
                <div class="config-grid">
                    <div class="form-group">
                        <label for="maoDominante">M√£o Dominante:</label>
                        <select id="maoDominante" onchange="validateAndLoad()">
                            <option value="D">Destro</option>
                            <option value="E">Canhoto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ladoCamera">Lado da C√¢mera:</label>
                        <select id="ladoCamera" onchange="validateAndLoad()">
                            <option value="D">Direita</option>
                            <option value="E">Esquerda</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ladoRaquete">Lado da Raquete:</label>
                        <select id="ladoRaquete" onchange="validateAndLoad()">
                            <option value="F">Forehand</option>
                            <option value="B">Backhand</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipoMovimento">Tipo de Movimento:</label>
                        <select id="tipoMovimento" onchange="validateAndLoad()">
                            <option value="D">Drive (Ataque)</option>
                            <option value="P">Push (Defesa)</option>
                        </select>
                    </div>
                </div>

                <h2>üèÜ Selecionar Profissional</h2>
                <button class="btn" onclick="loadProfessionals()" id="loadProfessionalsBtn">CARREGAR PROFISSIONAIS</button>
                <div id="professionalsList" class="professionals-grid"></div>

                <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #f8f9fa 0%, #e8f5e8 100%); border-radius: 15px; border: 2px solid #4a7c59;">
                    <h3 style="color: #2c5530; margin-bottom: 15px; display: flex; align-items: center;">
                        üß¨ <span style="margin-left: 10px;">An√°lise Biomec√¢nica Avan√ßada</span>
                    </h3>
                    <p style="margin-bottom: 20px; color: #666; font-size: 16px;">An√°lise detalhada de movimento com compara√ß√£o profissional autom√°tica</p>
                    
                    <div style="margin-bottom: 20px;">
                        <label for="cycleIndex" style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c5530;">Ciclo para an√°lise:</label>
                        <select id="cycleIndex" style="padding: 12px; border: 2px solid #4a7c59; border-radius: 8px; width: 150px; font-size: 16px;">
                            <option value="0">1¬∫ ciclo</option>
                            <option value="1" selected>2¬∫ ciclo (recomendado)</option>
                            <option value="2">3¬∫ ciclo</option>
                            <option value="3">4¬∫ ciclo</option>
                        </select>
                        <small style="display: block; margin-top: 5px; color: #666;">O 2¬∫ ciclo geralmente oferece os melhores resultados</small>
                    </div>
                    
                    <button class="btn" onclick="analyzeEnhancedCycle()" id="enhancedAnalyzeBtn" 
                            style="background: linear-gradient(135deg, #4a7c59 0%, #2c5530 100%); 
                                   padding: 15px 30px; font-size: 18px; font-weight: bold;
                                   box-shadow: 0 4px 15px rgba(76, 124, 89, 0.3);">
                        ‚ö° INICIAR AN√ÅLISE BIOMEC√ÇNICA
                    </button>
                </div>

                <div id="analysisStatus"></div>
                
                <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Analisando t√©cnica... Isso pode levar alguns minutos.</p>
                </div>

                <div id="results" class="results hidden">
                    <h3>üìä Resultados da An√°lise</h3>
                    <div id="scoreDisplay" class="score">64%</div>
                    <div id="analysisDetails"></div>
                </div>
            </div>
        </div>
    </div>

    



<script>
// Configura√ß√£o da API
const API_BASE = 'http://localhost:8000';
// Cache buster - vers√£o: 20250127-025000
let authToken = localStorage.getItem('token');

// Sistema de debug simples
function debugLog(message) {
    console.log("[DEBUG] " + message);
}

// Fun√ß√£o para obter configura√ß√£o atual da interface
function getCurrentConfig() {
    // Tentar ambos os formatos de ID (interface antiga e nova)
    const maoDominante = document.getElementById('maoDominante')?.value || 
                        document.getElementById('mao-dominante')?.value || 'Destro';
    const ladoCamera = document.getElementById('ladoCamera')?.value || 
                      document.getElementById('lado-camera')?.value || 'Esquerda';
    const ladoRaquete = document.getElementById('ladoRaquete')?.value || 
                       document.getElementById('lado-raquete')?.value || 'Forehand';
    const tipoMovimento = document.getElementById('tipoMovimento')?.value || 
                         document.getElementById('tipo-movimento')?.value || 'Drive (Ataque)';
    
    debugLog(`[CONFIG] Valores extra√≠dos: m√£o=${maoDominante}, c√¢mera=${ladoCamera}, raquete=${ladoRaquete}, movimento=${tipoMovimento}`);
    
    // Converter para formato esperado pelo backend
    const config = {
        'maoDominante': maoDominante === 'Destro' ? 'Destro' : 'Canhoto',
        'ladoCamera': ladoCamera === 'Esquerda' ? 'Esquerda' : 'Direita', 
        'ladoRaquete': ladoRaquete === 'Forehand' ? 'F' : 'B',
        'tipoMovimento': tipoMovimento.includes('Drive') ? 'D' : 'P'
    };
    
    debugLog(`[CONFIG] Configura√ß√£o final: ${JSON.stringify(config)}`);
    return config;
}

// Fun√ß√£o de login
async function login() {
    debugLog("=== EXECUTANDO LOGIN ===");
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    if (!username || !password) {
        alert('Preencha usu√°rio e senha');
        return;
    }
    
    try {
        debugLog("Chamando API de login...");
        const response = await fetch(`${API_BASE}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        debugLog("Resposta login: " + response.status);
        const data = await response.json();
        
        if (data.access_token) {
            authToken = data.access_token;
            localStorage.setItem('token', data.access_token);
            debugLog("Login realizado com sucesso");
            showMainInterface();
        } else {
            debugLog("Login falhou: " + data.detail);
            alert('Login falhou');
        }
    } catch (error) {
        debugLog("Erro login: " + error.message);
        alert('Erro de conex√£o');
    }
}

// Fun√ß√£o para mostrar interface principal
function showMainInterface() {
    debugLog("Mostrando interface principal");
    document.body.innerHTML = `
        <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
            <header style="background: #4a7c59; color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                <h1>üéæ Tennis Analyzer</h1>
                <p>An√°lise Avan√ßada de T√©cnica de T√™nis de Mesa</p>
                <button onclick="logout()" style="float: right; background: #fff; color: #4a7c59; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Logout</button>
            </header>
            
            <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h2>üìπ Upload do V√≠deo</h2>
                <input type="file" id="user-video" accept="video/*" onchange="handleFileChange()" style="width: 100%; padding: 10px; border: 2px dashed #ccc; border-radius: 5px; margin-bottom: 20px;">
                <div id="validation-message" style="display: none;"></div>
                
                <h3>‚öôÔ∏è Configura√ß√µes da An√°lise</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div>
                        <label>M√£o Dominante:</label>
                        <select id="mao-dominante" onchange="handleConfigChange()" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                            <option value="Destro">Destro</option>
                            <option value="Esquerdo">Esquerdo</option>
                        </select>
                    </div>
                    <div>
                        <label>Lado da C√¢mera:</label>
                        <select id="lado-camera" onchange="handleConfigChange()" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                            <option value="Direita">Direita</option>
                            <option value="Esquerda">Esquerda</option>
                        </select>
                    </div>
                    <div>
                        <label>Lado da Raquete:</label>
                        <select id="lado-raquete" onchange="handleConfigChange()" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                            <option value="Forehand">Forehand</option>
                            <option value="Backhand">Backhand</option>
                        </select>
                    </div>
                    <div>
                        <label>Tipo de Movimento:</label>
                        <select id="tipo-movimento" onchange="handleConfigChange()" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                            <option value="Drive (Ataque)">Drive (Ataque)</option>
                            <option value="Push (Defesa)">Push (Defesa)</option>
                        </select>
                    </div>
                </div>
                
                
                
                <div id="results" style="margin-top: 30px;"></div>
            </div>
        </div>
    `;
}

// Event handlers
function handleFileChange() {
    debugLog("*** ARQUIVO ALTERADO ***");
    validateAndProcess();
}

function handleConfigChange() {
    debugLog("*** CONFIGURACAO ALTERADA ***");
    validateAndProcess();
}

// Valida√ß√£o principal com debug
function validateAndProcess() {
    debugLog("=== INICIANDO VALIDACAO ===");
    
    const fileInput = document.getElementById('user-video');
    const fileName = fileInput && fileInput.files.length > 0 ? fileInput.files[0].name : '';
    
    if (!fileName) {
        debugLog("ERRO: Nenhum arquivo selecionado");
        disableButtons();
        return;
    }
    
    debugLog("Arquivo: " + fileName);
    
    // Extrair movimento do filename
    const fileMovement = extractMovementFromFilename(fileName);
    debugLog("Movimento do filename: " + fileMovement);
    
    // Obter configura√ß√£o do usu√°rio
    const userConfig = getUserConfiguration();
    const userMovement = userConfig.ladoRaquete + userConfig.tipoMovimento;
    
    debugLog("Configuracao usuario: " + JSON.stringify(userConfig));
    debugLog("Movimento configurado: " + userMovement);
    
    let validationResult = false;
    let message = "";
    
    // VALIDA√á√ÉO PRINCIPAL
    if (fileMovement !== 'unknown') {
        debugLog("=== VALIDACAO DIRETA (arquivo com metadados) ===");
        const isCompatible = fileMovement === userMovement;
        debugLog("Comparacao: " + fileMovement + " === " + userMovement + " = " + isCompatible);
        
        if (isCompatible) {
            debugLog("RESULTADO: APROVADO - movimentos compativeis");
            validationResult = true;
            message = "‚úÖ Arquivo e configura√ß√£o compat√≠veis";
        } else {
            debugLog("RESULTADO: REJEITADO - movimentos incompativeis");
            alert("VALIDACAO REJEITADA: " + fileMovement + " != " + userMovement);
            message = "‚ùå INCOMPATIBILIDADE: arquivo " + fileMovement + " vs config " + userMovement;
        }
    } else {
        debugLog("=== ARQUIVO SEM METADADOS - USANDO DETECCAO REAL ===");
        
        // Usar sistema real de detec√ß√£o de conte√∫do via API
        debugLog("Chamando API para deteccao de conteudo...");
        
        // Permitir an√°lise - detec√ß√£o real acontecer√° no backend durante an√°lise
        debugLog("=== PERMITINDO ANALISE COM DETECCAO AUTOMATICA ===");
        debugLog("Arquivo: " + fileName);
        debugLog("Configuracao: " + userMovement);
        debugLog("Sistema far√° deteccao automatica durante analise");
        
        validationResult = true;
        message = "‚ÑπÔ∏è ARQUIVO SEM METADADOS: Sistema usar√° detec√ß√£o autom√°tica de conte√∫do";
    }
    
    // Aplicar resultado
    showMessage(message, validationResult ? 'success' : 'error');
    
    if (validationResult) {
        enableButtons();
    } else {
        disableButtons();
    }
}

function extractMovementFromFilename(filename) {
    debugLog("Analisando filename: " + filename);
    
    const patterns = {
        'FD': /_FD_/i,
        'FP': /_FP_/i, 
        'BD': /_BD_/i,
        'BP': /_BP_/i
    };
    
    for (const [movement, pattern] of Object.entries(patterns)) {
        if (pattern.test(filename)) {
            debugLog("Padrao encontrado: " + movement);
            return movement;
        }
    }
    
    debugLog("Nenhum padrao encontrado - retornando unknown");
    return 'unknown';
}

function getUserConfiguration() {
    const config = {
        maoDominante: document.getElementById('mao-dominante')?.value || 'Destro',
        ladoRaquete: document.getElementById('lado-raquete')?.value || 'Forehand',
        ladoCamera: document.getElementById('lado-camera')?.value || 'Direita',
        tipoMovimento: document.getElementById('tipo-movimento')?.value || 'Drive (Ataque)'
    };
    
    debugLog("Config original: " + JSON.stringify(config));
    
    // Converter para formato do backend
    config.ladoRaquete = config.ladoRaquete === 'Forehand' ? 'F' : 'B';
    config.tipoMovimento = config.tipoMovimento.includes('Drive') ? 'D' : 'P';
    
    debugLog("Config convertida: " + JSON.stringify(config));
    
    return config;
}

function showMessage(message, type) {
    debugLog("Mostrando mensagem: " + message);
    
    let messageDiv = document.getElementById('validation-message');
    if (!messageDiv) {
        return;
    }
    
    if (type === 'error') {
        messageDiv.style.cssText = 'display: block; padding: 15px; margin: 15px 0; border-radius: 8px; font-size: 14px; font-weight: bold; background: #ffebee; color: #c62828; border: 2px solid #e57373;';
    } else if (type === 'success') {
        messageDiv.style.cssText = 'display: block; padding: 15px; margin: 15px 0; border-radius: 8px; font-size: 14px; font-weight: bold; background: #e8f5e8; color: #2e7d32; border: 2px solid #81c784;';
    }
    
    messageDiv.textContent = message;
}

function enableButtons() {
    debugLog("HABILITANDO botoes");
    const loadButton = document.getElementById('load-professionals-btn');
    if (loadButton) {
        loadButton.disabled = false;
        loadButton.style.background = '#4a7c59';
        loadButton.style.cursor = 'pointer';
    }
}

function disableButtons() {
    debugLog("DESABILITANDO botoes");
    const loadButton = document.getElementById('load-professionals-btn');
    const analyzeButton = document.getElementById('analyze-btn');
    
    if (loadButton) {
        loadButton.disabled = true;
        loadButton.style.background = '#ccc';
        loadButton.style.cursor = 'not-allowed';
    }
    
    if (analyzeButton) {
        analyzeButton.disabled = true;
        analyzeButton.style.background = '#ccc';
        analyzeButton.style.cursor = 'not-allowed';
    }
}

// Outras fun√ß√µes necess√°rias
async function loadProfessionals() {
    debugLog("=== CARREGANDO PROFISSIONAIS ===");
    
    const profList = document.getElementById('professionals-list');
    if (!profList) {
        debugLog("ERRO: Elemento professionals-list n√£o encontrado");
        return;
    }
    
    profList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Carregando profissionais...</div>';
    
    try {
        // Obter configura√ß√£o atual do usu√°rio
        const config = getCurrentConfig();
        debugLog(`[PROFESSIONALS] Configura√ß√£o atual: ${JSON.stringify(config)}`);
        
        // Determinar movement_type baseado na configura√ß√£o
        const movement_type = `${config.ladoRaquete === 'F' ? 'forehand' : 'backhand'}_${config.tipoMovimento === 'D' ? 'drive' : 'push'}`;
        
        debugLog(`Fazendo requisi√ß√£o para /professionals com movement_type: ${movement_type}`);
        const response = await fetch(`${API_BASE}/professionals?movement_type=${movement_type}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        debugLog(`Resposta recebida: ${response.status}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const response_data = await response.json();
        debugLog("Dados recebidos:", JSON.stringify(response_data, null, 2));
        
        const professionals = response_data.professionals || response_data;
        debugLog(`Total de profissionais: ${professionals.length}`);
        
        if (professionals.length === 0) {
            profList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum profissional encontrado para este tipo de movimento</div>';
            return;
        }
        
        profList.innerHTML = '';
        professionals.forEach((prof, index) => {
            debugLog(`Processando profissional ${index + 1}: ${prof.name}`);
            
            const profCard = document.createElement('div');
            profCard.style.cssText = 'border: 2px solid #ddd; padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s;';
            profCard.innerHTML = `
                <h4>${prof.name}</h4>
                <p><strong>M√£o:</strong> ${prof.hand === 'D' ? 'Destro' : 'Canhoto'}</p>
                <p><strong>C√¢mera:</strong> ${prof.camera_side === 'D' ? 'Direita' : 'Esquerda'}</p>
                <p style="font-size: 12px; color: #666;">${prof.filename}</p>
                ${prof.video_exists ? '<p style="color: green; font-size: 12px;">‚úÖ V√≠deo dispon√≠vel</p>' : '<p style="color: orange; font-size: 12px;">‚ö†Ô∏è V√≠deo n√£o encontrado</p>'}
            `;
            
            profCard.addEventListener('mouseover', function() {
                this.style.borderColor = '#4a7c59';
                this.style.backgroundColor = '#f0f8f0';
            });
            
            profCard.addEventListener('mouseout', function() {
                if (!this.classList.contains('selected')) {
                    this.style.borderColor = '#ddd';
                    this.style.backgroundColor = 'transparent';
                }
            });
            
            profCard.onclick = () => selectProfessional(prof, profCard);
            profList.appendChild(profCard);
        });
        
        debugLog("Profissionais carregados com sucesso");
        
    } catch (error) {
        debugLog(`ERRO ao carregar profissionais: ${error.message}`);
        profList.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #c62828; background: #ffebee; border-radius: 8px;">
                <strong>Erro ao carregar profissionais</strong><br>
                ${error.message}
            </div>
        `;
    }
}

let selectedProfessional = null;

function selectProfessional(prof, element) {
    debugLog(`=== SELECIONANDO PROFISSIONAL: ${prof.name} ===`);
    
    // Remover sele√ß√£o anterior
    document.querySelectorAll('#professionals-list > div').forEach(div => {
        div.style.border = '2px solid #ddd';
        div.style.backgroundColor = 'transparent';
        div.classList.remove('selected');
    });
    
    // Selecionar atual
    element.style.border = '2px solid #4a7c59';
    element.style.backgroundColor = '#e8f5e8';
    element.classList.add('selected');
    
    selectedProfessional = prof;
    debugLog(`Profissional selecionado: ${JSON.stringify(prof, null, 2)}`);
    
    // Ativar bot√£o de an√°lise
    const analyzeButton = document.getElementById('analyze-btn');
    if (analyzeButton) {
        analyzeButton.disabled = false;
        analyzeButton.style.background = '#4a7c59';
        analyzeButton.style.cursor = 'pointer';
        debugLog("Bot√£o de an√°lise ativado");
    }
}


// Enhanced biomechanical single cycle analysis
async function analyzeEnhancedCycle() {
    console.log("üî•üî•üî• [DEBUG] STARTING analyzeEnhancedCycle function üî•üî•üî•");
    debugLog("*** AN√ÅLISE BIOMEC√ÇNICA AVAN√áADA - FUN√á√ÉO analyzeEnhancedCycle() ***");
    debugLog("*** ENDPOINT QUE SER√Å CHAMADO: /analyze ***");
    
    const fileInput = document.getElementById('user-video');
    console.log("üî• [DEBUG] File input element:", fileInput);
    
    const currentFile = fileInput && fileInput.files.length > 0 ? fileInput.files[0] : null;
    console.log("üî• [DEBUG] Current file:", currentFile);
    
    if (!currentFile) {
        console.log("üî• [DEBUG] No file selected - showing alert");
        alert('Por favor, selecione um v√≠deo primeiro.');
        return;
    }

    // Get selected cycle index
    const cycleIndex = parseInt(document.getElementById('cycleIndex').value);
    console.log("üî• [DEBUG] Cycle index:", cycleIndex);
    
    // Get metadata
    const metadata = {
        maoDominante: document.getElementById('mao-dominante').value,
        ladoCamera: document.getElementById('lado-camera').value,
        ladoRaquete: document.getElementById('lado-raquete').value,
        tipoMovimento: document.getElementById('tipo-movimento').value
    };
    console.log("üî• [DEBUG] Metadata:", metadata);
    
    // For independent biomechanical analysis, professional is optional
    console.log("üî• [DEBUG] Selected professional:", selectedProfessional ? selectedProfessional.name : 'NONE (independent analysis)');

    try {
        // BYPASS AUTH FOR TESTING
        console.log("üî• [DEBUG] Starting API call preparation");
        debugLog("BYPASS: Pulando autentica√ß√£o para teste da biomec√¢nica");

        // Show loading
        const loadingElement = document.getElementById('loading');
        const resultsElement = document.getElementById('results');
        console.log("üî• [DEBUG] Loading element:", loadingElement);
        console.log("üî• [DEBUG] Results element:", resultsElement);
        
        if (loadingElement) {
            loadingElement.classList.remove('hidden');
            console.log("üî• [DEBUG] Loading shown");
        }
        if (resultsElement) {
            resultsElement.classList.add('hidden');
            console.log("üî• [DEBUG] Results hidden");
        }

        // Create form data
        const formData = new FormData();
        formData.append('user_video', currentFile);
        formData.append('metadata', JSON.stringify(metadata));
        formData.append('cycle_index', cycleIndex.toString());
        if (selectedProfessional) {
            formData.append('professional_name', selectedProfessional.name);
        }

        // Add enhanced analysis flag
        // Always use enhanced biomechanical analysis
        console.log("üî• [DEBUG] FormData created with enhanced_biomechanical type");
        
        console.log("üî• [DEBUG] About to make API call to:", `${API_BASE}/analyze`);
        debugLog(`[ENHANCED] Enviando para: ${API_BASE}/analyze`);
        debugLog(`[ENHANCED] *** FUNCTION: analyzeEnhancedCycle() ***`);
        debugLog(`[ENHANCED] *** ENDPOINT: /analyze ***`);
        debugLog(`[ENHANCED] Ciclo selecionado: ${cycleIndex}`);
        debugLog(`[ENHANCED] Metadata: ${JSON.stringify(metadata)}`);
        debugLog(`[ENHANCED] Tipo: analyze`);

        const response = await fetch(`${API_BASE}/analyze`, {
            method: 'POST',
            body: formData
        });

        console.log("üî• [DEBUG] Response received:", response);
        console.log("üî• [DEBUG] Response status:", response.status);
        console.log("üî• [DEBUG] Response ok:", response.ok);
        debugLog(`[ENHANCED] Status da resposta: ${response.status}`);

        const responseText = await response.text();
        console.log("üî• [DEBUG] Raw response text:", responseText);
        
        let result;
        try {
            result = JSON.parse(responseText);
            console.log("üî• [DEBUG] Parsed result:", result);
        } catch (parseError) {
            console.log("üî• [DEBUG] JSON parse error:", parseError);
            console.log("üî• [DEBUG] Raw response was:", responseText);
            throw new Error(`Invalid JSON response: ${responseText}`);
        }
        
        debugLog(`[ENHANCED] Resposta completa: ${JSON.stringify(result, null, 2)}`);

        // Hide loading
        const loadingToHide = document.getElementById('loading');
        if (loadingToHide) {
            loadingToHide.classList.add('hidden');
            console.log("üî• [DEBUG] Loading hidden after response");
        }

        if (response.ok && result.success) {
            console.log("üî• [DEBUG] Analysis successful - calling display function");
            debugLog("‚úÖ AN√ÅLISE BIOMEC√ÇNICA COMPLETADA COM SUCESSO");
            displayEnhancedBiomechanicalResults(result);
        } else {
            const errorMsg = result.error || result.detail || 'Erro na an√°lise biomec√¢nica';
            console.log("üî• [DEBUG] Analysis failed:", errorMsg);
            debugLog(`‚ùå ERRO NA AN√ÅLISE BIOMEC√ÇNICA: ${errorMsg}`);
            alert(`ERRO: ${errorMsg}`);
        }

    } catch (error) {
        debugLog(`‚ùå ERRO DE REDE: ${error.message}`);
        document.getElementById('loading').classList.add('hidden');
        alert(`Erro de comunica√ß√£o: ${error.message}`);
    }
}



function calculateSimilarity(userVal, proVal) {
    if (!userVal || !proVal || proVal === 0) return 0;
    const relDiff = Math.abs(userVal - proVal) / Math.abs(proVal);
    return Math.max(0, (1 - relDiff) * 100);
}

function getSimilarityColorGradient(similarity) {
    if (similarity >= 80) return 'linear-gradient(135deg, #4CAF50, #66BB6A)';  // Verde
    if (similarity >= 60) return 'linear-gradient(135deg, #2196F3, #42A5F5)';  // Azul
    if (similarity >= 40) return 'linear-gradient(135deg, #FF9800, #FFB74D)';  // Laranja
    return 'linear-gradient(135deg, #f44336, #EF5350)';  // Vermelho
}

function displayAnalysisResults(result) {
    const resultsDiv = document.getElementById('results');
    if (!resultsDiv) return;
    
    resultsDiv.innerHTML = `
        <div style="background: #f0f8f0; padding: 20px; border-radius: 10px; margin-top: 20px;">
            <h3>üìä Resultado da An√°lise</h3>
            <p><strong>Score Final:</strong> ${result.final_score || 'N/A'}</p>
            <p><strong>Tipo de An√°lise:</strong> ${result.analysis_type}</p>
            <p><strong>Data:</strong> ${new Date(result.timestamp).toLocaleString()}</p>
            ${result.detailed_analysis ? '<pre>' + JSON.stringify(result.detailed_analysis, null, 2) + '</pre>' : ''}
            ${result.recommendations ? '<h4>Recomenda√ß√µes:</h4><ul>' + result.recommendations.map(r => '<li>' + r + '</li>').join('') + '</ul>' : ''}
        </div>
    `;
}

function displayEnhancedBiomechanicalResults(result) {
    console.log('[ENHANCED_DISPLAY] Iniciando displayEnhancedBiomechanicalResults', result);
    
    // Remover qualquer resultado anterior
    const oldResults = document.getElementById('enhanced-biomech-results');
    if (oldResults) {
        oldResults.remove();
    }
    
    // Criar novo div de resultados
    const resultsDiv = document.createElement('div');
    resultsDiv.id = 'enhanced-biomech-results';
    resultsDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow: auto; padding: 20px;';
    
    const finalScore = result.final_score || 0;
    const performanceCategory = result.performance_category || 'N/A';
    
    // Extract confidence from nested structure
    let analysisConfidence = 0;
    if (result.detailed_analysis?.detailed_analysis?.movement_classification?.confidence) {
        analysisConfidence = result.detailed_analysis.detailed_analysis.movement_classification.confidence;
    } else {
        analysisConfidence = result.analysis_confidence || 0;
    }
    
    const cycleIndex = result.cycle_index || 1;
    
    // HTML do resultado
    const html = `
        <div style="max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; padding: 30px; position: relative;">
            <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px;">√ó</button>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <h1 style="color: #2c5530; margin-bottom: 10px;">üß¨ An√°lise Biomec√¢nica Avan√ßada</h1>
                <p style="color: #666; font-size: 18px;">Ciclo ${cycleIndex + 1} - An√°lise de Movimento √önico</p>
            </div>
            
            <!-- Score Principal -->
            <div style="background: linear-gradient(135deg, #4a7c59 0%, #2c5530 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 30px;">
                <h2 style="margin: 0; font-size: 3em;">${finalScore.toFixed(1)}%</h2>
                <p style="margin: 5px 0 0 0; font-size: 1.2em;">${performanceCategory}</p>
                <p style="margin: 5px 0 0 0; opacity: 0.8;">Confian√ßa da An√°lise: ${(analysisConfidence * 100).toFixed(1)}%</p>
            </div>
            
            <!-- Breakdown da Similaridade -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #2c5530; margin-bottom: 15px;">üìä An√°lise de Ciclo Tradicional</h3>
                    ${result.similarity_breakdown && result.similarity_breakdown.traditional_cycle_analysis ? `
                        <p><strong>Score:</strong> ${(result.similarity_breakdown.traditional_cycle_analysis.score * 100).toFixed(1)}%</p>
                        <p><strong>Peso:</strong> ${(result.similarity_breakdown.traditional_cycle_analysis.weight * 100).toFixed(0)}%</p>
                        <p><strong>Contribui√ß√£o:</strong> ${(result.similarity_breakdown.traditional_cycle_analysis.contribution * 100).toFixed(1)}%</p>
                    ` : '<p>Dados n√£o dispon√≠veis</p>'}
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #2c5530; margin-bottom: 15px;">ü¶¥ An√°lise Biomec√¢nica</h3>
                    ${result.similarity_breakdown && result.similarity_breakdown.biomechanical_analysis ? `
                        <p><strong>Score:</strong> ${(result.similarity_breakdown.biomechanical_analysis.score * 100).toFixed(1)}%</p>
                        <p><strong>Peso:</strong> ${(result.similarity_breakdown.biomechanical_analysis.weight * 100).toFixed(0)}%</p>
                        <p><strong>Contribui√ß√£o:</strong> ${(result.similarity_breakdown.biomechanical_analysis.contribution * 100).toFixed(1)}%</p>
                        <p><strong>Dispon√≠vel:</strong> ${result.similarity_breakdown.biomechanical_analysis.available ? '‚úÖ Sim' : '‚ùå N√£o'}</p>
                    ` : '<p>Dados n√£o dispon√≠veis</p>'}
                </div>
            </div>
            
            <!-- M√©tricas Detalhadas -->
            ${result.detailed_metrics ? generateDetailedMetricsHTML(result.detailed_metrics) : ''}
            
            <!-- Compara√ß√£o com Profissionais -->
            ${result.professional_comparisons && result.professional_comparisons.length > 0 ? generateProfessionalComparisonsHTML(result.professional_comparisons, result.movement_statistics) : ''}
            
            <!-- Recomenda√ß√µes -->
            ${result.recommendations && result.recommendations.length > 0 ? `
                <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #2c5530; margin-bottom: 15px;">üí° Recomenda√ß√µes Personalizadas</h3>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${result.recommendations.map(rec => `<li style="margin-bottom: 8px;">${rec}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            
            <!-- Informa√ß√µes da An√°lise -->
            <div style="background: #f1f3f4; padding: 15px; border-radius: 10px; font-size: 14px; color: #666;">
                <p><strong>ID da An√°lise:</strong> ${result.analysis_id}</p>
                <p><strong>Data/Hora:</strong> ${new Date(result.timestamp).toLocaleString()}</p>
                <p><strong>Tipo:</strong> ${result.analysis_type}</p>
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
    document.body.appendChild(resultsDiv);
    
    console.log('[ENHANCED_DISPLAY] HTML gerado e inserido no DOM');
}

function generateDetailedMetricsHTML(metrics) {
    let html = '<div style="margin-bottom: 30px;"><h3 style="color: #2c5530; margin-bottom: 20px;">üìà M√©tricas Detalhadas</h3>';
    
    // An√°lise de Ciclo
    if (metrics.cycle_analysis) {
        html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">';
        html += '<h4 style="color: #2c5530; margin-bottom: 15px;">üîÑ An√°lise de Ciclo</h4>';
        html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">';
        
        Object.entries(metrics.cycle_analysis).forEach(([key, data]) => {
            const similarity = data.similarity || 0;
            const color = getSimilarityColorGradient(similarity);
            html += `
                <div style="background: ${color}; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <h5 style="margin: 0 0 10px 0; text-transform: capitalize;">${key.replace('_', ' ')}</h5>
                    <p style="margin: 0; font-size: 0.9em;">Usu√°rio: ${typeof data.user === 'number' ? data.user.toFixed(3) : data.user}</p>
                    <p style="margin: 0; font-size: 0.9em;">Pro: ${typeof data.professional === 'number' ? data.professional.toFixed(3) : data.professional}</p>
                    <p style="margin: 5px 0 0 0; font-weight: bold;">${similarity.toFixed(1)}%</p>
                </div>
            `;
        });
        
        html += '</div></div>';
    }
    
    // An√°lise Biomec√¢nica
    if (metrics.biomechanical_analysis && metrics.biomechanical_analysis.available) {
        html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">';
        html += '<h4 style="color: #2c5530; margin-bottom: 15px;">ü¶¥ An√°lise Biomec√¢nica</h4>';
        html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">';
        
        const biomech = metrics.biomechanical_analysis;
        if (biomech.joint_similarity !== undefined) {
            html += `<div style="background: ${getSimilarityColorGradient(biomech.joint_similarity)}; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                <h5 style="margin: 0 0 10px 0;">Articula√ß√µes</h5>
                <p style="margin: 0; font-weight: bold;">${biomech.joint_similarity.toFixed(1)}%</p>
            </div>`;
        }
        
        if (biomech.racket_similarity !== undefined) {
            html += `<div style="background: ${getSimilarityColorGradient(biomech.racket_similarity)}; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                <h5 style="margin: 0 0 10px 0;">Raquete</h5>
                <p style="margin: 0; font-weight: bold;">${biomech.racket_similarity.toFixed(1)}%</p>
            </div>`;
        }
        
        if (biomech.posture_similarity !== undefined) {
            html += `<div style="background: ${getSimilarityColorGradient(biomech.posture_similarity)}; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                <h5 style="margin: 0 0 10px 0;">Postura</h5>
                <p style="margin: 0; font-weight: bold;">${biomech.posture_similarity.toFixed(1)}%</p>
            </div>`;
        }
        
        html += '</div></div>';
    } else {
        html += '<div style="background: #fff3cd; padding: 15px; border-radius: 10px; border-left: 4px solid #ffc107;">';
        html += '<p style="margin: 0; color: #856404;">‚ö†Ô∏è An√°lise biomec√¢nica n√£o dispon√≠vel para este v√≠deo.</p>';
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

function logout() {
    authToken = null;
    localStorage.removeItem('token');
    location.reload();
}

// Verificar token ao carregar
window.onload = function() {
    debugLog("P√°gina carregada");
    const token = localStorage.getItem('token');
    if (token) {
        authToken = token;
        showMainInterface();
    } else {
        // BYPASS TEMPOR√ÅRIO PARA TESTE
        debugLog("BYPASS: Pulando login para teste");
        authToken = "test-token-bypass";
        localStorage.setItem('token', authToken);
        showMainInterface();
    }
};

function generateProfessionalComparisonsHTML(comparisons, movementStats) {
    let html = '<div style="background: #f0f8f0; padding: 25px; border-radius: 15px; margin-bottom: 30px;">';
    html += '<h3 style="color: #2c5530; margin-bottom: 20px;">üèÜ Compara√ß√£o com Profissionais</h3>';
    
    // Estat√≠sticas do movimento
    if (movementStats && movementStats.count > 0) {
        html += '<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px;">';
        html += '<h4 style="color: #2c5530; margin-bottom: 10px;">üìä Estat√≠sticas do Movimento</h4>';
        html += '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; text-align: center;">';
        
        const stats = [
            { label: 'Varia√ß√£o Cotovelo', value: `${movementStats.elbow_variation.mean.toFixed(1)}¬∞`, desc: `¬±${movementStats.elbow_variation.std.toFixed(1)}¬∞` },
            { label: 'Coordena√ß√£o', value: `${(movementStats.coordination.mean * 100).toFixed(1)}%`, desc: `¬±${(movementStats.coordination.std * 100).toFixed(1)}%` },
            { label: 'Amplitude', value: movementStats.amplitude.mean.toFixed(3), desc: `¬±${movementStats.amplitude.std.toFixed(3)}` },
            { label: 'Velocidade', value: movementStats.velocity.mean.toFixed(3), desc: `¬±${movementStats.velocity.std.toFixed(3)}` }
        ];
        
        stats.forEach(stat => {
            html += `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                    <h5 style="margin: 0 0 5px 0; font-size: 0.9em; color: #666;">${stat.label}</h5>
                    <p style="margin: 0; font-weight: bold; color: #2c5530;">${stat.value}</p>
                    <p style="margin: 0; font-size: 0.8em; color: #888;">${stat.desc}</p>
                </div>
            `;
        });
        
        html += '</div></div>';
    }
    
    // Top 3 profissionais mais similares
    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
    
    comparisons.forEach((comparison, index) => {
        const similarityColor = getSimilarityColorGradient(comparison.similarity_score);
        const rankEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
        
        html += `
            <div style="background: white; border: 2px solid ${similarityColor}; border-radius: 12px; padding: 20px; position: relative;">
                <!-- Ranking badge -->
                <div style="position: absolute; top: -10px; right: -10px; background: ${similarityColor}; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold;">
                    ${index + 1}
                </div>
                
                <!-- Nome do profissional -->
                <h4 style="color: #2c5530; margin: 0 0 10px 0; font-size: 1.3em;">${comparison.professional_name}</h4>
                <p style="color: #666; margin: 0 0 15px 0; font-size: 0.9em;">${comparison.professional_video}</p>
                
                <!-- Score de similaridade -->
                <div style="background: ${similarityColor}; color: white; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 2em;">${comparison.similarity_percentage}</h3>
                    <p style="margin: 0; opacity: 0.9;">Similaridade</p>
                </div>
                
                <!-- M√©tricas detalhadas -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h5 style="color: #2c5530; margin: 0 0 10px 0;">üìà Compara√ß√£o Detalhada</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85em;">
        `;
        
        // Adicionar m√©tricas individuais
        const metrics = comparison.detailed_comparison.individual_similarities;
        Object.entries(metrics).forEach(([metric, similarity]) => {
            const percentage = (similarity * 100).toFixed(0);
            const color = similarity > 0.7 ? '#28a745' : similarity > 0.5 ? '#ffc107' : '#dc3545';
            
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0;">
                    <span style="text-transform: capitalize;">${metric.replace('_', ' ')}</span>
                    <span style="color: ${color}; font-weight: bold;">${percentage}%</span>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
                
                <!-- Recomenda√ß√µes espec√≠ficas -->
                ${comparison.recommendations && comparison.recommendations.length > 0 ? `
                    <div style="background: #e8f5e8; padding: 12px; border-radius: 8px;">
                        <h5 style="color: #2c5530; margin: 0 0 8px 0;">üí° Dicas Espec√≠ficas</h5>
                        <ul style="margin: 0; padding-left: 15px; font-size: 0.85em;">
                            ${comparison.recommendations.slice(0, 3).map(rec => `<li style="margin-bottom: 4px;">${rec}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                
                <!-- Confian√ßa da compara√ß√£o -->
                <div style="text-align: center; margin-top: 10px; font-size: 0.8em; color: #666;">
                    Confian√ßa: ${(comparison.comparison_confidence * 100).toFixed(1)}%
                </div>
            </div>
        `;
    });
    
    html += '</div></div>';
    return html;
}
</script>
</body>
</html>