<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Analyzer - An√°lise de T√©cnica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .content {
            padding: 40px;
        }
        .section {
            margin-bottom: 40px;
        }
        .section h2 {
            color: #2c5530;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .login-section {
            max-width: 400px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus {
            border-color: #4a7c59;
            outline: none;
        }
        .btn {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .upload-area {
            border: 3px dashed #4a7c59;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-area:hover {
            background: #e9ecef;
            border-color: #2c5530;
        }
        .upload-area.dragover {
            background: #e8f5e8;
            border-color: #2c5530;
        }
        .file-info {
            background: #e8f5e8;
            border: 2px solid #4a7c59;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .professional-card {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .professional-card:hover {
            border-color: #4a7c59;
            background: #e8f5e8;
        }
        .professional-card.selected {
            border-color: #2c5530;
            background: #2c5530;
            color: white;
        }
        .professionals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .results {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
        }
        .score {
            font-size: 4em;
            font-weight: bold;
            color: #e17055;
            margin: 20px 0;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a7c59;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéæ Tennis Analyzer</h1>
            <p>An√°lise Avan√ßada de T√©cnica de T√™nis de Mesa</p>
        </div>

        <div class="content">
            <!-- Login Section -->
            <div id="loginSection" class="section">
                <div class="login-section">
                    <h2>üîí Login</h2>
                    <div class="form-group">
                        <label for="username">Usu√°rio:</label>
                        <input type="text" id="username" value="demo">
                    </div>
                    <div class="form-group">
                        <label for="password">Senha:</label>
                        <input type="password" id="password" value="demo123">
                    </div>
                    <button class="btn" onclick="login()">ENTRAR</button>
                </div>
            </div>

            <!-- Analysis Section -->
            <div id="analysisSection" class="section hidden">
                <h2>üé• An√°lise de V√≠deo</h2>
                
                <div class="form-group">
                    <label>Selecionar V√≠deo:</label>
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div id="uploadText">
                            <p><strong>Clique aqui ou arraste um v√≠deo</strong></p>
                            <p>Formatos suportados: MP4, AVI, MOV</p>
                        </div>
                        <div id="fileInfo" class="file-info hidden">
                            <span id="fileName"></span>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".mp4,.avi,.mov" style="display: none;" onchange="handleFileSelect(this.files[0])">
                </div>

                <h2>‚öôÔ∏è Configura√ß√µes da An√°lise</h2>
                <div class="config-grid">
                    <div class="form-group">
                        <label for="maoDominante">M√£o Dominante:</label>
                        <select id="maoDominante" onchange="validateAndLoad()">
                            <option value="D">Destro</option>
                            <option value="E">Canhoto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ladoCamera">Lado da C√¢mera:</label>
                        <select id="ladoCamera" onchange="validateAndLoad()">
                            <option value="D">Direita</option>
                            <option value="E">Esquerda</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ladoRaquete">Lado da Raquete:</label>
                        <select id="ladoRaquete" onchange="validateAndLoad()">
                            <option value="F">Forehand</option>
                            <option value="B">Backhand</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipoMovimento">Tipo de Movimento:</label>
                        <select id="tipoMovimento" onchange="validateAndLoad()">
                            <option value="D">Drive (Ataque)</option>
                            <option value="P">Push (Defesa)</option>
                        </select>
                    </div>
                </div>

                <h2>üèÜ Selecionar Profissional</h2>
                <button class="btn" onclick="loadProfessionals()" id="loadProfessionalsBtn">CARREGAR PROFISSIONAIS</button>
                <div id="professionalsList" class="professionals-grid"></div>

                <button class="btn" onclick="analyzeVideo()" id="analyzeBtn" style="margin-top: 30px;">üî¨ ANALISAR T√âCNICA</button>

                <div id="analysisStatus"></div>
                
                <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                    <p>Analisando t√©cnica... Isso pode levar alguns minutos.</p>
                </div>

                <div id="results" class="results hidden">
                    <h3>üìä Resultados da An√°lise</h3>
                    <div id="scoreDisplay" class="score">64%</div>
                    <div id="analysisDetails"></div>
                </div>
            </div>
        </div>
    </div>

    



<script>
// Configura√ß√£o da API
const API_BASE = 'http://localhost:8001';
let authToken = localStorage.getItem('token');

// Sistema de debug simples
function debugLog(message) {
    console.log("[DEBUG] " + message);
}

// Fun√ß√£o de login
async function login() {
    debugLog("=== EXECUTANDO LOGIN ===");
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    if (!username || !password) {
        alert('Preencha usu√°rio e senha');
        return;
    }
    
    try {
        debugLog("Chamando API de login...");
        const response = await fetch(`${API_BASE}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        debugLog("Resposta login: " + response.status);
        const data = await response.json();
        debugLog("Dados do login: " + JSON.stringify(data));
        
        if (data.access_token) {
            authToken = data.access_token;
            localStorage.setItem('token', data.access_token);
            debugLog("Login realizado com sucesso - Token: " + authToken.substring(0, 50) + "...");
            showMainInterface();
        } else {
            debugLog("Login falhou: " + (data.detail || 'Dados inv√°lidos'));
            alert('Login falhou: ' + (data.detail || 'Dados inv√°lidos'));
        }
    } catch (error) {
        debugLog("Erro login: " + error.message);
        alert('Erro de conex√£o: ' + error.message);
    }
}

// Fun√ß√£o para mostrar interface principal
function showMainInterface() {
    debugLog("Mostrando interface principal");
    document.body.innerHTML = `
        <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
            <header style="background: #4a7c59; color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                <h1>üéæ Tennis Analyzer</h1>
                <p>An√°lise Avan√ßada de T√©cnica de T√™nis de Mesa</p>
                <button onclick="logout()" style="float: right; background: #fff; color: #4a7c59; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Logout</button>
            </header>
            
            <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h2>üìπ Upload do V√≠deo</h2>
                <input type="file" id="user-video" accept="video/*" onchange="handleFileChange()" style="width: 100%; padding: 10px; border: 2px dashed #ccc; border-radius: 5px; margin-bottom: 20px;">
                <div id="validation-message" style="display: none;"></div>
                
                <h3>‚öôÔ∏è Configura√ß√µes da An√°lise</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div>
                        <label>M√£o Dominante:</label>
                        <select id="mao-dominante" onchange="handleConfigChange()" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                            <option value="Destro">Destro</option>
                            <option value="Esquerdo">Esquerdo</option>
                        </select>
                    </div>
                    <div>
                        <label>Lado da C√¢mera:</label>
                        <select id="lado-camera" onchange="handleConfigChange()" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                            <option value="Direita">Direita</option>
                            <option value="Esquerda">Esquerda</option>
                        </select>
                    </div>
                    <div>
                        <label>Lado da Raquete:</label>
                        <select id="lado-raquete" onchange="handleConfigChange()" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                            <option value="Forehand">Forehand</option>
                            <option value="Backhand">Backhand</option>
                        </select>
                    </div>
                    <div>
                        <label>Tipo de Movimento:</label>
                        <select id="tipo-movimento" onchange="handleConfigChange()" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                            <option value="Drive (Ataque)">Drive (Ataque)</option>
                            <option value="Push (Defesa)">Push (Defesa)</option>
                        </select>
                    </div>
                </div>
                
                <button onclick="loadProfessionals()" id="load-professionals-btn" style="width: 100%; background: #ccc; color: white; padding: 15px; border: none; border-radius: 5px; font-size: 16px; cursor: not-allowed; margin: 20px 0;" disabled>
                    CARREGAR PROFISSIONAIS
                </button>
                
                <h3>üèÜ Selecionar Profissional</h3>
                <div id="professionals-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="text-align: center; padding: 20px; color: #666;">Fa√ßa upload e configure para carregar profissionais</div>
                </div>
                
                <button onclick="startAnalysis()" id="analyze-btn" disabled style="width: 100%; background: #ccc; color: white; padding: 15px; border: none; border-radius: 5px; font-size: 16px; cursor: not-allowed; margin: 20px 0;">
                    INICIAR AN√ÅLISE
                </button>
                
                <div id="results" style="margin-top: 30px;"></div>
            </div>
        </div>
    `;
}

// Event handlers
function handleFileChange() {
    debugLog("*** ARQUIVO ALTERADO ***");
    validateAndProcess();
}

function handleConfigChange() {
    debugLog("*** CONFIGURACAO ALTERADA ***");
    validateAndProcess();
}

// Valida√ß√£o principal com debug
function validateAndProcess() {
    debugLog("=== INICIANDO VALIDACAO ===");
    
    const fileInput = document.getElementById('user-video');
    const fileName = fileInput && fileInput.files.length > 0 ? fileInput.files[0].name : '';
    
    if (!fileName) {
        debugLog("ERRO: Nenhum arquivo selecionado");
        disableButtons();
        return;
    }
    
    debugLog("Arquivo: " + fileName);
    
    // Extrair movimento do filename
    const fileMovement = extractMovementFromFilename(fileName);
    debugLog("Movimento do filename: " + fileMovement);
    
    // Obter configura√ß√£o do usu√°rio
    const userConfig = getUserConfiguration();
    const userMovement = userConfig.ladoRaquete + userConfig.tipoMovimento;
    
    debugLog("Configuracao usuario: " + JSON.stringify(userConfig));
    debugLog("Movimento configurado: " + userMovement);
    
    let validationResult = false;
    let message = "";
    
    // VALIDA√á√ÉO PRINCIPAL
    if (fileMovement !== 'unknown') {
        debugLog("=== VALIDACAO DIRETA (arquivo com metadados) ===");
        const isCompatible = fileMovement === userMovement;
        debugLog("Comparacao: " + fileMovement + " === " + userMovement + " = " + isCompatible);
        
        if (isCompatible) {
            debugLog("RESULTADO: APROVADO - movimentos compativeis");
            validationResult = true;
            message = "‚úÖ Arquivo e configura√ß√£o compat√≠veis";
        } else {
            debugLog("RESULTADO: REJEITADO - movimentos incompativeis");
            alert("VALIDACAO REJEITADA: " + fileMovement + " != " + userMovement);
            message = "‚ùå INCOMPATIBILIDADE: arquivo " + fileMovement + " vs config " + userMovement;
        }
    } else {
        debugLog("=== ARQUIVO SEM METADADOS - USANDO DETECCAO REAL ===");
        
        // Usar sistema real de detec√ß√£o de conte√∫do via API
        debugLog("Chamando API para deteccao de conteudo...");
        
        // Permitir an√°lise - detec√ß√£o real acontecer√° no backend durante an√°lise
        debugLog("=== PERMITINDO ANALISE COM DETECCAO AUTOMATICA ===");
        debugLog("Arquivo: " + fileName);
        debugLog("Configuracao: " + userMovement);
        debugLog("Sistema far√° deteccao automatica durante analise");
        
        validationResult = true;
        message = "‚ÑπÔ∏è ARQUIVO SEM METADADOS: Sistema usar√° detec√ß√£o autom√°tica de conte√∫do";
    }
    
    // Aplicar resultado
    showMessage(message, validationResult ? 'success' : 'error');
    
    if (validationResult) {
        enableButtons();
    } else {
        disableButtons();
    }
}

function extractMovementFromFilename(filename) {
    debugLog("Analisando filename: " + filename);
    
    const patterns = {
        'FD': /_FD_/i,
        'FP': /_FP_/i, 
        'BD': /_BD_/i,
        'BP': /_BP_/i
    };
    
    for (const [movement, pattern] of Object.entries(patterns)) {
        if (pattern.test(filename)) {
            debugLog("Padrao encontrado: " + movement);
            return movement;
        }
    }
    
    debugLog("Nenhum padrao encontrado - retornando unknown");
    return 'unknown';
}

function getUserConfiguration() {
    const config = {
        maoDominante: document.getElementById('mao-dominante')?.value || 'Destro',
        ladoRaquete: document.getElementById('lado-raquete')?.value || 'Forehand',
        ladoCamera: document.getElementById('lado-camera')?.value || 'Direita',
        tipoMovimento: document.getElementById('tipo-movimento')?.value || 'Drive (Ataque)'
    };
    
    debugLog("Config original: " + JSON.stringify(config));
    
    // Converter para formato do backend
    config.ladoRaquete = config.ladoRaquete === 'Forehand' ? 'F' : 'B';
    config.tipoMovimento = config.tipoMovimento.includes('Drive') ? 'D' : 'P';
    
    debugLog("Config convertida: " + JSON.stringify(config));
    
    return config;
}

function showMessage(message, type) {
    debugLog("Mostrando mensagem: " + message);
    
    let messageDiv = document.getElementById('validation-message');
    if (!messageDiv) {
        return;
    }
    
    if (type === 'error') {
        messageDiv.style.cssText = 'display: block; padding: 15px; margin: 15px 0; border-radius: 8px; font-size: 14px; font-weight: bold; background: #ffebee; color: #c62828; border: 2px solid #e57373;';
    } else if (type === 'success') {
        messageDiv.style.cssText = 'display: block; padding: 15px; margin: 15px 0; border-radius: 8px; font-size: 14px; font-weight: bold; background: #e8f5e8; color: #2e7d32; border: 2px solid #81c784;';
    }
    
    messageDiv.textContent = message;
}

function enableButtons() {
    debugLog("HABILITANDO botoes");
    const loadButton = document.getElementById('load-professionals-btn');
    if (loadButton) {
        loadButton.disabled = false;
        loadButton.style.background = '#4a7c59';
        loadButton.style.cursor = 'pointer';
    }
}

function disableButtons() {
    debugLog("DESABILITANDO botoes");
    const loadButton = document.getElementById('load-professionals-btn');
    const analyzeButton = document.getElementById('analyze-btn');
    
    if (loadButton) {
        loadButton.disabled = true;
        loadButton.style.background = '#ccc';
        loadButton.style.cursor = 'not-allowed';
    }
    
    if (analyzeButton) {
        analyzeButton.disabled = true;
        analyzeButton.style.background = '#ccc';
        analyzeButton.style.cursor = 'not-allowed';
    }
}

// Outras fun√ß√µes necess√°rias
async function loadProfessionals() {
    debugLog("=== CARREGANDO PROFISSIONAIS ===");
    
    // Obter arquivo do input
    const fileInput = document.getElementById('user-video');
    const currentFile = fileInput && fileInput.files.length > 0 ? fileInput.files[0] : null;
    
    if (!currentFile) {
        alert("Por favor, selecione um v√≠deo primeiro.");
        return;
    }
    
    const profList = document.getElementById('professionals-list');
    if (!profList) {
        debugLog("ERRO: Elemento professionals-list n√£o encontrado");
        return;
    }
    
    profList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ü§ñ Validando v√≠deo e carregando profissionais...</div>';
    
    try {
        const config = getCurrentConfig();
        debugLog(`[VALIDATION] Enviando arquivo ${currentFile.name} para valida√ß√£o`);
        debugLog(`[VALIDATION] Configura√ß√£o: ${JSON.stringify(config)}`);
        
        const formData = new FormData();
        formData.append('file', currentFile);
        formData.append('metadata', JSON.stringify(config));
        
        debugLog("Fazendo requisi√ß√£o POST para /validate-and-get-professionals");
        debugLog(`Token sendo usado: ${authToken ? authToken.substring(0, 50) + '...' : 'NENHUM TOKEN'}`);
        
        const response = await fetch(`${API_BASE}/validate-and-get-professionals`, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${authToken}`,
                'Accept': 'application/json'
            },
            body: formData
        });
        
        debugLog(`Resposta recebida: ${response.status}`);
        
        if (!response.ok) {
            const errorData = await response.json();
            const errorMsg = errorData.detail || response.statusText;
            debugLog(`‚ùå ERRO DE VALIDA√á√ÉO: ${errorMsg}`);
            profList.innerHTML = `<div style="text-align: center; padding: 20px; color: #d32f2f; background: #ffebee; border-radius: 5px;">
                <strong>‚ùå ERRO DE VALIDA√á√ÉO:</strong><br>${errorMsg}
            </div>`;
            alert(`ERRO DE VALIDA√á√ÉO: ${errorMsg}`);
            return;
        }
        
        const response_data = await response.json();
        debugLog("Dados recebidos:", JSON.stringify(response_data, null, 2));
        
        const professionals = response_data.professionals || response_data;
        debugLog(`Total de profissionais: ${professionals.length}`);
        
        if (professionals.length === 0) {
            profList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Nenhum profissional encontrado para este tipo de movimento</div>';
            return;
        }
        
        profList.innerHTML = '';
        professionals.forEach((prof, index) => {
            debugLog(`Processando profissional ${index + 1}: ${prof.name}`);
            
            const profCard = document.createElement('div');
            profCard.style.cssText = 'border: 2px solid #ddd; padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.3s;';
            profCard.innerHTML = `
                <h4>${prof.name}</h4>
                <p>M√£o: ${prof.hand === 'D' ? 'Destro' : 'Canhoto'}</p>
                <p>C√¢mera: ${prof.camera_side === 'D' ? 'Direita' : 'Esquerda'}</p>
                <p style="font-size: 12px; color: #666;">${prof.filename}</p>
            `;
            
            profCard.addEventListener('mouseover', function() {
                this.style.borderColor = '#4a7c59';
                this.style.backgroundColor = '#f0f8f0';
            });
            
            profCard.addEventListener('mouseout', function() {
                if (!this.classList.contains('selected')) {
                    this.style.borderColor = '#ddd';
                    this.style.backgroundColor = 'transparent';
                }
            });
            
            profCard.onclick = () => selectProfessional(prof, profCard);
            profList.appendChild(profCard);
        });
        
        debugLog("Profissionais carregados com sucesso");
        
    } catch (error) {
        debugLog(`ERRO ao carregar profissionais: ${error.message}`);
        profList.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #c62828; background: #ffebee; border-radius: 8px;">
                <strong>Erro ao carregar profissionais</strong><br>
                ${error.message}
            </div>
        `;
    }
}

let selectedProfessional = null;

function selectProfessional(prof, element) {
    debugLog(`=== SELECIONANDO PROFISSIONAL: ${prof.name} ===`);
    
    // Remover sele√ß√£o anterior
    document.querySelectorAll('#professionals-list > div').forEach(div => {
        div.style.border = '2px solid #ddd';
        div.style.backgroundColor = 'transparent';
        div.classList.remove('selected');
    });
    
    // Selecionar atual
    element.style.border = '2px solid #4a7c59';
    element.style.backgroundColor = '#e8f5e8';
    element.classList.add('selected');
    
    selectedProfessional = prof;
    debugLog(`Profissional selecionado: ${JSON.stringify(prof, null, 2)}`);
    
    // Ativar bot√£o de an√°lise
    const analyzeButton = document.getElementById('analyze-btn');
    if (analyzeButton) {
        analyzeButton.disabled = false;
        analyzeButton.style.background = '#4a7c59';
        analyzeButton.style.cursor = 'pointer';
        debugLog("Bot√£o de an√°lise ativado");
    }
}

function getCurrentConfig() {
    const config = {
        maoDominante: document.getElementById('mao-dominante')?.value || 'Destro',
        ladoCamera: document.getElementById('lado-camera')?.value || 'Direita',
        ladoRaquete: document.getElementById('lado-raquete')?.value || 'Forehand',
        tipoMovimento: document.getElementById('tipo-movimento')?.value || 'Drive (Ataque)'
    };
    
    debugLog("Config original: " + JSON.stringify(config));
    
    // Converter para formato do backend
    config.ladoRaquete = config.ladoRaquete === 'Forehand' ? 'F' : 'B';
    config.tipoMovimento = config.tipoMovimento.includes('Drive') ? 'D' : 'P';
    
    debugLog("Config convertida: " + JSON.stringify(config));
    return config;
}

async function startAnalysis() {
    debugLog("*** INICIANDO AN√ÅLISE ***");
    
    // Obter arquivo do input
    const fileInput = document.getElementById('user-video');
    const currentFile = fileInput && fileInput.files.length > 0 ? fileInput.files[0] : null;
    
    debugLog(`Arquivo encontrado: ${currentFile ? currentFile.name : 'NENHUM'}`);
    debugLog(`Profissional selecionado: ${selectedProfessional ? selectedProfessional.name : 'NENHUM'}`);
    
    if (!currentFile || !selectedProfessional) {
        alert("Por favor, selecione um arquivo e um profissional primeiro.");
        return;
    }
    
    const analyzeButton = document.getElementById('analyze-btn');
    if (analyzeButton) {
        analyzeButton.disabled = true;
        analyzeButton.textContent = 'ANALISANDO...';
        analyzeButton.style.background = '#ccc';
    }
    
    try {
        const config = getCurrentConfig();
        debugLog(`[AN√ÅLISE] Configura√ß√£o: ${JSON.stringify(config)}`);
        
        const formData = new FormData();
        formData.append('user_video', currentFile);
        formData.append('metadata', JSON.stringify(config));
        formData.append('professional_name', selectedProfessional.name);
        formData.append('analysis_type', 'full');
        
        debugLog(`[AN√ÅLISE] Enviando para: ${API_BASE}/analyze`);
        debugLog(`[AN√ÅLISE] Token: ${authToken ? 'PRESENTE' : 'AUSENTE'}`);
        
        const response = await fetch(`${API_BASE}/analyze`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
            },
            body: formData
        });
        
        debugLog(`[AN√ÅLISE] Status da resposta: ${response.status}`);
        
        const result = await response.json();
        debugLog(`[AN√ÅLISE] Resposta completa: ${JSON.stringify(result, null, 2)}`);
        
        if (response.ok && result.success) {
            debugLog("‚úÖ AN√ÅLISE COMPLETADA COM SUCESSO");
            displayAnalysisResults(result);
        } else {
            const errorMsg = result.detail || result.error || 'Erro na an√°lise';
            debugLog(`‚ùå ERRO NA AN√ÅLISE: ${errorMsg}`);
            console.error('Erro detalhado:', result);
            alert(`ERRO DE VALIDA√á√ÉO: ${errorMsg}`);
        }
        
    } catch (error) {
        debugLog(`‚ùå ERRO DE REDE: ${error.message}`);
        alert(`Erro de comunica√ß√£o: ${error.message}`);
    } finally {
        if (analyzeButton) {
            analyzeButton.disabled = false;
            analyzeButton.textContent = 'INICIAR AN√ÅLISE';
            analyzeButton.style.background = '#4a7c59';
        }
    }
}

function displayAnalysisResults(result) {
    const resultsDiv = document.getElementById('results');
    if (!resultsDiv) return;
    
    // Extrair dados para compara√ß√£o
    let userAnalysis = result.user_analysis || {};
    let proAnalysis = result.professional_analysis || {};
    let comparison = result.comparison || {};
    let detailedSimilarities = comparison.detailed_similarities || {};
    
    // DEBUG: Log what we actually received from API
    console.log('[API_DEBUG] Received result:', result);
    console.log('[API_DEBUG] user_analysis keys:', Object.keys(userAnalysis));
    console.log('[API_DEBUG] professional_analysis keys:', Object.keys(proAnalysis));
    console.log('[API_DEBUG] comparison keys:', Object.keys(comparison));
    
    // HONEST APPROACH: Only show real data, display clear message when data is missing
    const hasDetailedMetrics = Object.keys(userAnalysis).length > 0 && 
                               Object.keys(proAnalysis).length > 0 && 
                               Object.keys(detailedSimilarities).length > 0;
    
    if (!hasDetailedMetrics) {
        console.log('[WARNING] Detailed biomechanical metrics not available from API');
        
        // Show a clear message to the user about missing detailed analysis
        resultsDiv.innerHTML = `
            <div style="background: #fff; padding: 30px; border-radius: 15px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #3498db, #2980b9); border-radius: 10px; color: white;">
                    <h2 style="margin: 0; font-size: 2.5em;">${(result.final_score || 0).toFixed(1)}%</h2>
                    <p style="margin: 5px 0 0 0; font-size: 1.3em; opacity: 0.9;">An√°lise B√°sica Conclu√≠da</p>
                    <p style="margin: 5px 0 0 0; font-size: 0.9em; opacity: 0.8;">Sistema de an√°lise biomec√¢nica em manuten√ß√£o</p>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #e74c3c;">
                    <h3 style="color: #e74c3c; margin-top: 0;">‚ö†Ô∏è An√°lise Limitada</h3>
                    <p style="margin-bottom: 0; color: #2c3e50;">
                        O sistema conseguiu calcular seu score geral, mas os par√¢metros biomec√¢nicos detalhados 
                        n√£o est√£o dispon√≠veis no momento. Para an√°lise completa com m√©tricas de ritmo, 
                        suavidade e efici√™ncia de movimento, entre em contato com o suporte t√©cnico.
                    </p>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="showUploadForm()" style="background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 1em;">
                        Nova An√°lise
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    // Fun√ß√£o para formatar porcentagens
    const formatPercent = (value) => {
        if (value === undefined || value === null) return 'N/A';
        return (value * 100).toFixed(1) + '%';
    };
    
    // Fun√ß√£o para formatar n√∫meros
    const formatNumber = (value, decimals = 2) => {
        if (value === undefined || value === null) return 'N/A';
        return Number(value).toFixed(decimals);
    };
    
    // Determinar n√≠vel de performance
    const score = result.final_score || 0;
    let performanceLevel = 'Precisa Melhorar';
    let performanceColor = '#e74c3c';
    
    if (score >= 90) {
        performanceLevel = 'Excepcional';
        performanceColor = '#27ae60';
    } else if (score >= 80) {
        performanceLevel = 'Excelente';
        performanceColor = '#2ecc71';
    } else if (score >= 70) {
        performanceLevel = 'Bom';
        performanceColor = '#f39c12';
    } else if (score >= 60) {
        performanceLevel = 'Regular';
        performanceColor = '#e67e22';
    }
    
    resultsDiv.innerHTML = `
        <div style="background: #fff; padding: 30px; border-radius: 15px; margin-top: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <!-- Header com Score Principal -->
            <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, ${performanceColor}, ${performanceColor}dd); border-radius: 10px; color: white;">
                <h2 style="margin: 0; font-size: 2.5em;">${formatNumber(score, 1)}%</h2>
                <p style="margin: 5px 0 0 0; font-size: 1.3em; opacity: 0.9;">${performanceLevel}</p>
                <p style="margin: 5px 0 0 0; font-size: 0.9em; opacity: 0.8;">An√°lise: ${result.analysis_type || 'Desconhecido'}</p>
            </div>

            <!-- Tabela Comparativa Detalhada -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #2c5530; margin-bottom: 20px; border-bottom: 2px solid #4a7c59; padding-bottom: 10px;">
                    üìä Compara√ß√£o Detalhada: Voc√™ vs. Profissional
                </h3>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #2c5530, #4a7c59); color: white;">
                            <th style="padding: 15px; text-align: left; border: none;">Par√¢metro</th>
                            <th style="padding: 15px; text-align: center; border: none;">Seu Resultado</th>
                            <th style="padding: 15px; text-align: center; border: none;">Profissional</th>
                            <th style="padding: 15px; text-align: center; border: none;">Similaridade</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; font-weight: 600; border-bottom: 1px solid #dee2e6;">üîÑ Ciclos Detectados</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${userAnalysis.cycles_count || 'N/A'}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${proAnalysis.cycles_count || 'N/A'}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">-</td>
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; font-weight: 600; border-bottom: 1px solid #dee2e6;">‚è±Ô∏è Dura√ß√£o M√©dia (s)</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatNumber(userAnalysis.average_duration)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatNumber(proAnalysis.average_duration)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(detailedSimilarities.duration)}</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; font-weight: 600; border-bottom: 1px solid #dee2e6;">üìè Amplitude de Movimento</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">-</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">-</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(detailedSimilarities.amplitude)}</td>
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; font-weight: 600; border-bottom: 1px solid #dee2e6;">üéØ Consist√™ncia</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(userAnalysis.consistency_score)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(proAnalysis.consistency_score)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(detailedSimilarities.consistency)}</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; font-weight: 600; border-bottom: 1px solid #dee2e6;">‚≠ê Qualidade do Movimento</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(userAnalysis.quality_score)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(proAnalysis.quality_score)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(detailedSimilarities.quality)}</td>
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; font-weight: 600; border-bottom: 1px solid #dee2e6;">üéµ Variabilidade do Ritmo</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(userAnalysis.rhythm_variability)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(proAnalysis.rhythm_variability)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(detailedSimilarities.rhythm_variability)}</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; font-weight: 600; border-bottom: 1px solid #dee2e6;">üåä Suavidade de Acelera√ß√£o</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(userAnalysis.acceleration_smoothness)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(proAnalysis.acceleration_smoothness)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(detailedSimilarities.acceleration_smoothness)}</td>
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; font-weight: 600; border-bottom: 1px solid #dee2e6;">‚ö° Efici√™ncia do Movimento</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(userAnalysis.movement_efficiency)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(proAnalysis.movement_efficiency)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(detailedSimilarities.movement_efficiency)}</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; font-weight: 600; border-bottom: 1px solid #dee2e6;">üìê Consist√™ncia de Amplitude</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(userAnalysis.amplitude_consistency)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(proAnalysis.amplitude_consistency)}</td>
                            <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${formatPercent(detailedSimilarities.amplitude_consistency)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- M√©tricas de Score Detalhadas -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #2c5530; margin-bottom: 20px; border-bottom: 2px solid #4a7c59; padding-bottom: 10px;">
                    üîç Composi√ß√£o do Score Final
                </h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.8em; font-weight: bold; color: #2c5530;">${formatPercent(comparison.similarity_score)}</div>
                        <div style="color: #666; margin-top: 5px;">Similaridade Geral</div>
                        <div style="font-size: 0.9em; color: #888; margin-top: 3px;">(Peso: 40%)</div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.8em; font-weight: bold; color: #856404;">${formatPercent(userAnalysis.quality_score)}</div>
                        <div style="color: #666; margin-top: 5px;">Sua Qualidade</div>
                        <div style="font-size: 0.9em; color: #888; margin-top: 3px;">(Peso: 30%)</div>
                    </div>
                    
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.8em; font-weight: bold; color: #155724;">${formatPercent(userAnalysis.consistency_score)}</div>
                        <div style="color: #666; margin-top: 5px;">Sua Consist√™ncia</div>
                        <div style="font-size: 0.9em; color: #888; margin-top: 3px;">(Peso: 20%)</div>
                    </div>
                    
                    <div style="background: #cce5ff; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.8em; font-weight: bold; color: #004085;">${userAnalysis.cycles_count || 0}</div>
                        <div style="color: #666; margin-top: 5px;">B√¥nus Ciclos</div>
                        <div style="font-size: 0.9em; color: #888; margin-top: 3px;">(Peso: 10%)</div>
                    </div>
                </div>
            </div>

            <!-- Recomenda√ß√µes -->
            ${result.recommendations && result.recommendations.length > 0 ? `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #2c5530; margin-bottom: 15px; border-bottom: 2px solid #4a7c59; padding-bottom: 10px;">
                        üí° Recomenda√ß√µes Personalizadas
                    </h3>
                    <div style="background: #f8f9fa; border-left: 4px solid #4a7c59; padding: 15px;">
                        <ul style="margin: 0; padding-left: 20px;">
                            ${result.recommendations.map(r => `<li style="margin-bottom: 8px; color: #333;">${r}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            ` : ''}

            <!-- Informa√ß√µes T√©cnicas -->
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em; color: #666;">
                <strong>Info T√©cnica:</strong> 
                An√°lise ${result.data_estimated ? 'estimada' : 'real'} ‚Ä¢ 
                Confian√ßa: ${formatPercent(comparison.comparison_confidence)} ‚Ä¢ 
                Data: ${new Date().toLocaleString()}
            </div>
        </div>
    `;
}

function logout() {
    authToken = null;
    localStorage.removeItem('token');
    location.reload();
}

// Verificar token ao carregar
window.onload = function() {
    debugLog("P√°gina carregada");
    const token = localStorage.getItem('token');
    if (token) {
        authToken = token;
        debugLog("Token encontrado no localStorage: " + token.substring(0, 50) + "...");
        showMainInterface();
    } else {
        debugLog("Nenhum token encontrado no localStorage");
    }
};
</script>
</body>
</html>