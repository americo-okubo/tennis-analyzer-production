<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Analyzer - Enhanced Analysis with Biomechanics</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .score-display {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            color: white;
        }
        .score-excellent { background-color: #4CAF50; }
        .score-good { background-color: #2196F3; }
        .score-fair { background-color: #FF9800; }
        .score-poor { background-color: #f44336; }
        
        .analysis-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        .comparison-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn-enhanced {
            background-color: #2196F3;
        }
        .btn-enhanced:hover {
            background-color: #0b7dda;
        }
        .loading {
            display: none;
            text-align: center;
            font-size: 18px;
            color: #666;
        }
        .error {
            color: red;
            text-align: center;
            font-weight: bold;
        }
        .cycle-info {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .biomech-section {
            background-color: #f0f8ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
        }
        .traditional-section {
            background-color: #f9f9f9;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin: 15px 0;
        }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .confidence-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .high-confidence { background-color: #4CAF50; }
        .medium-confidence { background-color: #FF9800; }
        .low-confidence { background-color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéæ Tennis Analyzer</h1>
            <h2>Enhanced Analysis: Single Cycle + Biomechanics</h2>
            <p>Combines reliable single-cycle detection with scientific biomechanical analysis</p>
        </div>

        <div style="text-align: center;">
            <button class="btn btn-enhanced" onclick="testEnhancedAnalysis()">Execute Enhanced Analysis</button>
            <button class="btn" onclick="testTraditionalAnalysis()">Execute Traditional Analysis</button>
        </div>

        <div id="loading" class="loading">
            ‚è≥ Executing analysis... (may take 2-3 minutes for full biomechanical analysis)
        </div>

        <div id="error" class="error"></div>

        <div id="results" style="display: none;">
            <div id="score-section">
                <div id="final-score" class="score-display">85%</div>
                <div class="cycle-info">
                    <div id="analysis-info">
                        <strong>Analysis Type:</strong> <span id="analysis-type">Enhanced</span> |
                        <strong>Performance Category:</strong> <span id="performance-category">Advanced</span> |
                        <strong>Confidence:</strong> <span id="analysis-confidence" class="confidence-indicator high-confidence">95%</span>
                    </div>
                </div>
            </div>

            <div class="metric-grid">
                <div class="metric-card traditional-section">
                    <h3>üìä Single Cycle Analysis</h3>
                    <div id="traditional-metrics">
                        <p><strong>Cycle Analyzed:</strong> <span id="cycle-index">2nd cycle</span></p>
                        <p><strong>Cycles Found:</strong> <span id="cycles-found">5</span></p>
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>You</th>
                                    <th>Professional</th>
                                    <th>Similarity</th>
                                </tr>
                            </thead>
                            <tbody id="traditional-tbody">
                                <!-- Traditional metrics will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="metric-card biomech-section" id="biomech-card">
                    <h3>üî¨ Biomechanical Analysis</h3>
                    <div id="biomech-metrics">
                        <div id="biomech-available">
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th>Parameter</th>
                                        <th>You</th>
                                        <th>Professional</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody id="biomech-tbody">
                                    <!-- Biomechanical metrics will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="biomech-unavailable" style="display: none;">
                            <p>‚ùå Biomechanical analysis not available for this comparison</p>
                            <p>Analysis continues with traditional single-cycle method only.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="analysis-section">
                <h3>üìà Recommendations</h3>
                <div id="recommendations">
                    <!-- Recommendations will be inserted here -->
                </div>
            </div>

            <div class="analysis-section">
                <h3>üîç Detailed Analysis</h3>
                <div id="detailed-analysis">
                    <!-- Detailed analysis will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8007';

        async function testEnhancedAnalysis() {
            await executeAnalysis('/enhanced-single-cycle-analysis', 'Enhanced Analysis');
        }

        async function testTraditionalAnalysis() {
            await executeAnalysis('/single-cycle-analysis', 'Traditional Analysis');
        }

        async function executeAnalysis(endpoint, analysisName) {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const resultsDiv = document.getElementById('results');
            
            // Show loading, hide others
            loadingDiv.style.display = 'block';
            errorDiv.textContent = '';
            resultsDiv.style.display = 'none';
            
            try {
                console.log(`[${analysisName}] Starting analysis...`);
                
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log(`[${analysisName}] Result:`, result);
                
                if (result.success) {
                    displayResults(result, analysisName);
                } else {
                    throw new Error(result.error || 'Analysis failed');
                }
                
            } catch (error) {
                console.error(`[${analysisName}] Error:`, error);
                errorDiv.textContent = `‚ùå Erro: ${error.message}`;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function displayResults(result, analysisName) {
            const resultsDiv = document.getElementById('results');
            const scoreDiv = document.getElementById('final-score');
            
            // Show results
            resultsDiv.style.display = 'block';
            
            // Display final score
            const score = result.final_score;
            scoreDiv.textContent = `${score.toFixed(1)}%`;
            
            // Set score color
            scoreDiv.className = 'score-display ';
            if (score >= 80) scoreDiv.className += 'score-excellent';
            else if (score >= 60) scoreDiv.className += 'score-good'; 
            else if (score >= 40) scoreDiv.className += 'score-fair';
            else scoreDiv.className += 'score-poor';
            
            // Analysis info
            document.getElementById('analysis-type').textContent = analysisName;
            document.getElementById('performance-category').textContent = 
                result.performance_category || 'Intermediate';
            
            const confidenceSpan = document.getElementById('analysis-confidence');
            const confidence = (result.analysis_confidence || 0.8) * 100;
            confidenceSpan.textContent = `${confidence.toFixed(0)}%`;
            confidenceSpan.className = 'confidence-indicator ' + 
                (confidence >= 80 ? 'high-confidence' : 
                 confidence >= 60 ? 'medium-confidence' : 'low-confidence');
            
            // Cycle info
            document.getElementById('cycle-index').textContent = 
                `${result.cycle_index || 1} cycle`;
            document.getElementById('cycles-found').textContent = 
                `${result.user_analysis.cycles_count || 'Unknown'}`;
            
            // Traditional metrics
            displayTraditionalMetrics(result);
            
            // Biomechanical metrics (if available)
            displayBiomechanicalMetrics(result);
            
            // Recommendations
            displayRecommendations(result);
            
            // Detailed analysis
            displayDetailedAnalysis(result);
        }

        function displayTraditionalMetrics(result) {
            const tbody = document.getElementById('traditional-tbody');
            tbody.innerHTML = '';
            
            const userAnalysis = result.user_analysis;
            const proAnalysis = result.professional_analysis;
            
            const metrics = [
                {
                    key: 'average_duration',
                    label: 'Duration',
                    unit: 's',
                    format: (val) => val.toFixed(3)
                },
                {
                    key: 'amplitude',
                    label: 'Amplitude',
                    unit: '',
                    format: (val) => val.toFixed(0)
                },
                {
                    key: 'quality_score',
                    label: 'Quality',
                    unit: '%',
                    format: (val) => (val * 100).toFixed(1)
                }
            ];
            
            metrics.forEach(metric => {
                const row = tbody.insertRow();
                const userValue = userAnalysis[metric.key] || 0;
                const proValue = proAnalysis[metric.key] || 0;
                
                // Calculate similarity
                let similarity = 0;
                if (proValue !== 0) {
                    const relDiff = Math.abs(userValue - proValue) / Math.abs(proValue);
                    similarity = Math.max(0, 1 - relDiff) * 100;
                }
                
                row.innerHTML = `
                    <td><strong>${metric.label}</strong></td>
                    <td>${metric.format(userValue)}${metric.unit}</td>
                    <td>${metric.format(proValue)}${metric.unit}</td>
                    <td style="color: ${getSimilarityColor(similarity / 100)}">
                        ${similarity.toFixed(1)}%
                    </td>
                `;
            });
        }

        function displayBiomechanicalMetrics(result) {
            const biomechCard = document.getElementById('biomech-card');
            const biomechAvailable = document.getElementById('biomech-available');
            const biomechUnavailable = document.getElementById('biomech-unavailable');
            const tbody = document.getElementById('biomech-tbody');
            
            // Check if enhanced analysis is available
            const isEnhanced = result.analysis_type && 
                             result.analysis_type.includes('enhanced');
            
            if (isEnhanced && result.user_analysis.enhanced_metrics && 
                result.user_analysis.enhanced_metrics.biomechanical_metrics && 
                result.user_analysis.enhanced_metrics.biomechanical_metrics.has_biomechanical_data) {
                
                // Show biomechanical data
                biomechAvailable.style.display = 'block';
                biomechUnavailable.style.display = 'none';
                
                tbody.innerHTML = '';
                
                const userBiomech = result.user_analysis.enhanced_metrics.biomechanical_metrics;
                const proBiomech = result.professional_analysis.enhanced_metrics.biomechanical_metrics;
                
                const biomechMetrics = [
                    {
                        key: 'joint_score',
                        label: 'Joint Analysis',
                        format: (val) => (val * 100).toFixed(1),
                        unit: '%'
                    },
                    {
                        key: 'racket_score', 
                        label: 'Racket Movement',
                        format: (val) => (val * 100).toFixed(1),
                        unit: '%'
                    },
                    {
                        key: 'posture_score',
                        label: 'Body Posture',
                        format: (val) => (val * 100).toFixed(1),
                        unit: '%'
                    }
                ];
                
                biomechMetrics.forEach(metric => {
                    if (userBiomech[metric.key] !== undefined && proBiomech[metric.key] !== undefined) {
                        const row = tbody.insertRow();
                        const userValue = userBiomech[metric.key];
                        const proValue = proBiomech[metric.key];
                        
                        // Calculate similarity
                        let similarity = 0;
                        if (proValue !== 0) {
                            const relDiff = Math.abs(userValue - proValue) / Math.abs(proValue);
                            similarity = Math.max(0, 1 - relDiff);
                        }
                        
                        row.innerHTML = `
                            <td><strong>${metric.label}</strong></td>
                            <td>${metric.format(userValue)}${metric.unit}</td>
                            <td>${metric.format(proValue)}${metric.unit}</td>
                            <td style="color: ${getSimilarityColor(similarity)}">
                                ${(similarity * 100).toFixed(1)}%
                            </td>
                        `;
                    }
                });
                
            } else {
                // Hide biomechanical data
                biomechAvailable.style.display = 'none';
                biomechUnavailable.style.display = 'block';
            }
        }

        function displayRecommendations(result) {
            const recommendationsDiv = document.getElementById('recommendations');
            const recommendations = result.recommendations || [];
            
            if (recommendations.length > 0) {
                let html = '<ul>';
                recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                html += '</ul>';
                recommendationsDiv.innerHTML = html;
            } else {
                recommendationsDiv.innerHTML = '<p>No specific recommendations available.</p>';
            }
        }

        function displayDetailedAnalysis(result) {
            const detailedDiv = document.getElementById('detailed-analysis');
            
            let html = '<div>';
            
            if (result.detailed_analysis) {
                const detailed = result.detailed_analysis;
                
                html += `<p><strong>Assessment:</strong> ${detailed.overall_assessment || 'Analysis completed'}</p>`;
                
                if (detailed.detailed_metrics) {
                    html += '<h4>Key Metrics:</h4>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">';
                    
                    Object.entries(detailed.detailed_metrics).forEach(([category, metrics]) => {
                        html += `<div style="background: #f9f9f9; padding: 10px; border-radius: 5px;">`;
                        html += `<h5>${category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</h5>`;
                        
                        if (typeof metrics === 'object') {
                            Object.entries(metrics).forEach(([key, value]) => {
                                if (typeof value === 'number') {
                                    html += `<p>${key.replace('_', ' ')}: ${value.toFixed(2)}</p>`;
                                }
                            });
                        }
                        html += '</div>';
                    });
                    
                    html += '</div>';
                }
            }
            
            html += '</div>';
            detailedDiv.innerHTML = html;
        }

        function getSimilarityColor(similarity) {
            if (similarity >= 0.8) return '#4CAF50';  // Green
            if (similarity >= 0.6) return '#2196F3';  // Blue
            if (similarity >= 0.4) return '#FF9800';  // Orange
            return '#f44336';  // Red
        }

        // Test connection on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                console.log('[CONNECTION] Server status:', data.message);
            } catch (error) {
                document.getElementById('error').textContent = 
                    '‚ö†Ô∏è Server not connected. Make sure simple_test_server.py is running on port 8002.';
            }
        });
    </script>
</body>
</html>